# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

SQIsign is a C implementation of the SQIsign post-quantum digital signature scheme. The codebase is organized into modular sub-libraries that implement various cryptographic primitives, culminating in the final SQIsign signature and verification protocols.

## Build Commands

### Basic Build
```bash
mkdir -p build
cd build
cmake -DSQISIGN_BUILD_TYPE=ref ..
make
```

### Build Types
- `ref`: Reference implementation (default)
- `opt`: Optimized implementation (same as ref currently)
- `broadwell`: Intel Broadwell-optimized implementation (optimized field arithmetic)

### Release Build
```bash
cmake -DSQISIGN_BUILD_TYPE=ref -DCMAKE_BUILD_TYPE=Release ..
make
```

### Testing
```bash
# From build directory
make test
# or
ctest
# With custom timeout
ctest --timeout <seconds>
```

### Generate KAT Files
```bash
# From build directory
apps/PQCgenKAT_sign_<level>
# where <level> is lvl1, lvl3, or lvl5
```

### Run Benchmarks
```bash
# From build directory
apps/benchmark_<level> [--iterations=<iterations>]
```

### Code Formatting
```bash
# From project root
find ./src -path ./src/precomp -prune -type f -o -iname '*.h' -o -iname '*.c' | xargs clang-format -i
```

## Build Options

Key CMake options (set with `-D<OPTION>=<VALUE>`):

- `SQISIGN_BUILD_TYPE`: ref/opt/broadwell - Implementation variant
- `CMAKE_BUILD_TYPE`: Release/Debug/ASAN/MSAN/LSAN/UBSAN
- `ENABLE_SIGN`: ON (default) for full signing, OFF for verification-only (removes GMP dependency)
- `GMP_LIBRARY`: SYSTEM (default), BUILD, or MINI
- `ENABLE_STRICT`: ON (default) - Enable strict compile warnings

## Architecture

### Module Dependencies

The codebase follows a layered architecture with clear dependencies:

```
Keygen / Sign / Verify
         ↓
    Quaternions ← Ideal <-> Iso → Verification
         ↓              ↓
         ↓          2D Isogenies → Precomputation
         ↓              ↓              ↓
    GMP (mp) ← Elliptic Curves ← Precomputation
                      ↓
              GF(p) & GF(p^2) + Fixed precision integers
```

### Source Modules

Located in `src/`, each module has a specific role:

- **common**: Hash functions (SHAKE), AES, PRNG, seed expansion, memory handling
- **mp**: Saturated-representation multiprecision arithmetic
- **gf**: Finite field arithmetic (GF(p) and GF(p²))
- **ec**: Elliptic curves, isogenies, and pairings
- **precomp**: Pre-computed constants and values
- **quaternion**: Quaternion orders and ideals
- **hd**: (2,2)-isogenies in the theta model
- **id2iso**: Ideal ↔ Isogeny translation
- **verification**: Verification protocol implementation
- **signature**: Key generation and signature protocols
- **nistapi**: NIST API wrapper

### Code Organization Pattern

Each module follows a strict hierarchical structure:

```
src/<module_name>/
├── include/              # Public headers (cross-module)
├── <module_name>x/       # Common source code (all impl types)
│   └── test/             # Common tests
├── ref/                  # Reference implementation
│   ├── include/          # Ref-specific public headers
│   ├── lvlx/             # Shared code across NIST levels
│   │   └── test/
│   ├── lvl1/             # NIST level 1
│   │   ├── include/
│   │   └── test/
│   ├── lvl3/             # NIST level 3
│   └── lvl5/             # NIST level 5
├── opt/                  # Optimized implementation (if exists)
└── broadwell/            # Broadwell-specific implementation (if exists)
```

**Implementation Selection**: The build system automatically selects implementation based on `SQISIGN_BUILD_TYPE`:
- Checks for architecture-specific implementations first (broadwell, arm64crypto)
- Falls back to `opt` if `SQISIGN_BUILD_TYPE=opt`
- Falls back to `ref` by default

**Generic Variants**: If a module has a `generic/` directory (parameter-independent), it takes precedence over level-specific implementations.

### Parameter Levels

The codebase supports three NIST security levels (lvl1, lvl3, lvl5). Each level has different parameters and security properties. Code in `lvlx/` directories is shared across all three levels.

## Testing Strategy

### Unit Tests
- Located in `src/<module>/<impl_type>/<variant>/test/`
- Test individual module functionality
- Example: `src/gf/gfx/test/test_fp.c`

### Integration Tests
- Located in `test/` directory
- Test cross-module interactions
- Key file: `test/test_sqisign.c`

### KAT (Known Answer Tests)
- Located in `KAT/` directory
- Generated by `apps/PQCgenKAT_sign_<level>`
- Validates consistency across implementations
- Tested via `SQIsign_<level>_KAT` test suite

### Self-Tests
- Random self-tests: `SQIsign_<level>_SELFTEST`
- Tests key generation, signing, and verification

## Important Coding Conventions

### Naming
- Public functions/types must be prefixed with module name
- Use `typedef` for structs and meaningful type aliases

### Parameters
- Output arguments come first
- Mark input arguments as `const`
- Pass small objects by value, large objects by pointer reference

### Global State
- Global constants are acceptable (especially field parameters in modules like `gf`)
- Global mutable state is forbidden

### Documentation
- All public headers must have extensive Doxygen documentation
- Use Doxygen format for all function/type declarations in public headers

### Code Style
- C11 standard
- Must compile cleanly with GCC and Clang without warnings
- Use `clang-format` for formatting (see formatting command above)
- Pre-commit hooks available: `pre-commit install`

## Special Considerations

### Pre-computation Scripts
- Pre-computed values in `src/precomp/` were generated by scripts in `scripts/precomp/`
- Requires external dependencies (two-isogenies, deuring-2D) - not needed for normal builds
- Don't modify `src/precomp/` without regenerating

### GMP Dependency
- Required only when `ENABLE_SIGN=ON`
- Verification-only builds don't need GMP
- Can use system GMP, build custom GMP, or use mini-gmp

### pqm4 (ARM Cortex-M4)
- Verification-only support for embedded ARM platforms
- Special KAT generator: `apps/PQCgenKAT_sign_pqm4.c`
- Use `scripts/gen_pqm4_sources.sh` to generate pqm4-compatible sources

## Development Workflow

From DEVELOPERS.md guidelines:
- Work on topic branches, never push WIP to `main`
- Create pull requests for completed work
- Request at least one review before merging
- CI automatically builds documentation PDF (available in GitHub Actions artifacts for 2 days)
